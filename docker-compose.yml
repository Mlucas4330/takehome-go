services:
    postgres:
        image: postgres:15-alpine
        container_name: takehome-go-db
        environment:
            POSTGRES_USER: postgres
            POSTGRES_PASSWORD: postgres
            POSTGRES_DB: takehome_db
        ports:
            - '5432:5432'
        volumes:
            - postgres_data:/var/lib/postgresql/data
        healthcheck:
            test: ['CMD-SHELL', 'pg_isready -U postgres']
            interval: 10s
            timeout: 5s
            retries: 5

    flyway:
        image: flyway/flyway:latest
        container_name: takehome-go-migrations
        command: -url=jdbc:postgresql://postgres:5432/takehome_db -user=postgres -password=postgres -connectRetries=60 migrate
        volumes:
            - ./migrations:/flyway/sql
        depends_on:
            postgres:
                condition: service_healthy

    api:
        build: .
        container_name: takehome-go-api
        environment:
            DB_HOST: postgres
            DB_PORT: 5432
            DB_USER: postgres
            DB_PASSWORD: postgres
            DB_NAME: takehome_db
        ports:
            - '8080:8080'
        depends_on:
            flyway:
                condition: service_completed_successfully
        restart: unless-stopped

volumes:
    postgres_data:
